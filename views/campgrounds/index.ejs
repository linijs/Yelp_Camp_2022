<% layout('./layouts/boilerplate')%>

<div class="container mb-4">
    <div class="headings">
        <span class="text-muted">What we offer</span>
        <h2 class="text-center">Best parks around Latvia, free to explore.</h2>
        <p class="text-paragraph">
            We produce high-performance, compact homes that let you escape the
            everyday to a space that is good for you and good for the planet.
        </p>
    </div>
</div>

<div id="cluster-map"></div>
<div id="map-error" class="alert alert-warning d-none" role="alert">
    There was an issue loading the map. This might be due to an ad blocker or
    security software.
</div>

<div class="container-custom my-3">
    <div class="secondary-heading">
        <h1 class="mb-4">Most popular parks, <br />showcased here</h1>
        <p>
            Built to go virtually anywhere, our models are the starting and
            <br />
            end point for all your adventures.
        </p>
    </div>

    <!-- New horizontal scrollable section -->
    <div class="popular-parks-container">
        <div class="popular-parks-scroll" id="popularParks">
            <% const popularParks = campgrounds.docs.sort(() => 0.5 -
            Math.random()).slice(0, 4); %> <% for (let park of popularParks) {
            %>
            <div class="popular-park-card">
                <div class="lazy-image-container">
                    <div
                        class="lazy-image-placeholder"
                        style="
                            background-image: url('<%= park.images && park.images.length ? park.images[0].url : 'https://res.cloudinary.com/drvf1bwps/image/upload/v1650983178/YelpCamp/yxcc5gwoe16lk7kapphq.jpg' %>');
                        "
                    ></div>
                    <img
                        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="
                        data-src="<%= park.images && park.images.length ? park.images[0].url : 'https://res.cloudinary.com/drvf1bwps/image/upload/v1650983178/YelpCamp/yxcc5gwoe16lk7kapphq.jpg' %>"
                        alt="<%= park.title %>"
                        class="lazy-image loading"
                    />
                </div>
                <div class="popular-park-info">
                    <h3><%= park.title %></h3>
                    <p><%= park.location %></p>
                    <a
                        href="/campgrounds/<%= park._id %>"
                        class="btn btn-primary"
                        >View Details</a
                    >
                </div>
            </div>
            <% } %>
        </div>
    </div>
</div>

<div class="container-custom my-3">
    <div class="container mb-4">
        <div class="headings">
            <span class="text-muted" id="all-parks">All parks</span>
            <h2 class="text-center">
                Best parks around Latvia, free to explore.
            </h2>
            <p class="text-paragraph">
                We produce high-performance, compact homes that let you escape
                the everyday to a space that is good for you and good for the
                planet.
            </p>
        </div>
    </div>

    <% if (campgrounds && campgrounds.docs && campgrounds.docs.length > 0) { %>
    <!-- Add the campground display code here -->
    <div class="row">
        <% for(let campground of campgrounds.docs) { %>
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-img-container lazy-image-container">
                    <div
                        class="lazy-image-placeholder"
                        style="
                            background-image: url('<%= campground.images && campground.images.length ? campground.images[0].url : 'https://res.cloudinary.com/drvf1bwps/image/upload/v1650983178/YelpCamp/yxcc5gwoe16lk7kapphq.jpg' %>');
                        "
                    ></div>
                    <img
                        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="
                        data-src="<%= campground.images && campground.images.length ? campground.images[0].url : 'https://res.cloudinary.com/drvf1bwps/image/upload/v1650983178/YelpCamp/yxcc5gwoe16lk7kapphq.jpg' %>"
                        class="card-img-top lazy-image loading"
                        alt="<%= campground.title %>"
                    />
                    <span
                        class="badge bg-primary position-absolute top-0 end-0 m-2"
                    >
                        $<%= campground.price %>/night
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title"><%= campground.title %></h5>
                    <p class="card-text text-muted mb-2">
                        <i class="fas fa-map-marker-alt"></i> <%=
                        campground.location %>
                    </p>
                    <p class="card-text flex-grow-1">
                        <%= campground.description.substring(0, 100) %>...
                    </p>
                    <div
                        class="d-flex justify-content-between align-items-end mt-3"
                    >
                        <div class="btn-group">
                            <a
                                href="/campgrounds/<%= campground._id %>"
                                class="btn btn-primary"
                                >View Details</a
                            >
                        </div>
                        <small class="text-muted"
                            ><i class="fas fa-star text-warning"></i> 4.5 (42
                            reviews)</small
                        >
                    </div>
                </div>
            </div>
        </div>
        <% } %>
    </div>

    <% if (campgrounds.totalPages > 1) { %>
    <nav aria-label="Campground pagination">
        <ul class="pagination justify-content-center">
            <% if (campgrounds.hasPrevPage) { %>
            <li class="page-item">
                <a
                    class="page-link"
                    href="/campgrounds?page=<%=campgrounds.prevPage%>#all-parks"
                    aria-label="Previous"
                >
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <% } %> <% if (typeof pageNumbers !== 'undefined' &&
            pageNumbers.length > 0) { %> <% pageNumbers.forEach(number => { %>
            <% if (number === '...') { %>
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            <% } else { %>
            <li class="page-item <%= number === currentPage ? 'active' : '' %>">
                <a
                    class="page-link"
                    href="/campgrounds?page=<%= number %>#all-parks"
                    ><%= number %></a
                >
            </li>
            <% } %> <% }) %> <% } %> <% if (campgrounds.hasNextPage) { %>
            <li class="page-item">
                <a
                    class="page-link"
                    href="/campgrounds?page=<%=campgrounds.nextPage%>#all-parks"
                    aria-label="Next"
                >
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <% } %>
        </ul>
    </nav>
    <% } %> <% } else { %>
    <p>No campgrounds found.</p>
    <% } %>
</div>

<style>
    .card {
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .card-img-container {
        height: 250px;
        overflow: hidden;
        position: relative;
    }
    .card-img-top {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .card-body {
        display: flex;
        flex-direction: column;
    }
    .card-text {
        flex-grow: 1;
    }
    .badge {
        font-size: 0.9rem;
    }

    /* Add these new styles for pagination */
    .pagination .page-link {
        color: black;
    }
    .pagination .page-item.active .page-link {
        background-color: black;
        border-color: black;
        color: white;
    }
    .pagination .page-link:hover {
        color: #333;
        background-color: #e9ecef;
        border-color: #dee2e6;
    }

    /* New styles for lazy loading images */
    .lazy-image-container {
        position: relative;
        overflow: hidden;
    }

    .lazy-image {
        transition: filter 0.5s;
    }

    .lazy-image.loading {
        filter: blur(10px);
    }

    .lazy-image-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        filter: blur(10px);
        transform: scale(1.1);
    }
</style>

<script>
    const mapToken = '<%-process.env.MAPBOX_TOKEN%>';
    const campgrounds = { features: <%- JSON.stringify(campgrounds && campgrounds.docs ? campgrounds.docs : []) %> };

    window.addEventListener('error', function(e) {
        if (e.target.src && e.target.src.includes('mapbox')) {
            document.getElementById('cluster-map').style.display = 'none';
            document.getElementById('map-error').classList.remove('d-none');
        }
    }, true);
</script>

<script src="/javascripts/lazyLoading.js"></script>
<script src="/javascripts/smoothScroll.js"></script>
<script src="/javascripts/popularParksSlider.js"></script>
<script src="/javascripts/clusterMap.js"></script>
